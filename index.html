<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì†Œë¦¬ ì í”„ ì¥ì• ë¬¼ ê²Œì„</title>
  <style>
    body {
      margin: 0;
      background: #222;
      color: #fff;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
    }
    #gameCanvas {
      background: #333;
      border: 2px solid #555;
      margin-top: 10px;
    }
    #info {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      line-height: 1.5;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ì†Œë¦¬ë¡œ ì í”„í•˜ëŠ” ì¥ì• ë¬¼ ê²Œì„</h2>
  <button id="startBtn">ë§ˆì´í¬ í—ˆìš© í›„ ê²Œì„ ì‹œì‘</button>
  <canvas id="gameCanvas" width="800" height="400"></canvas>

  <div id="info">
    ğŸ”Š ë§ˆì´í¬ì— ëŒ€ê³  ì†Œë¦¬ë¥¼ ë‚´ë©´ ì í”„í•©ë‹ˆë‹¤.<br>
    ì‘ì€ ì†Œë¦¬ â†’ ë‚®ê²Œ ì í”„ / í° ì†Œë¦¬ â†’ ë†’ê²Œ ì í”„<br>
    (ì¡°ìš©í•œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!)
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");

    // ì˜¤ë””ì˜¤ ê´€ë ¨ ë³€ìˆ˜
    let audioContext, analyser, dataArray;
    let micReady = false;

    // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
    const groundY = 320; // ë°”ë‹¥ ë†’ì´
    const gravity = 0.6;
    let obstacles = [];
    let spawnTimer = 0;
    let spawnInterval = 1500; // ms
    let lastTime = 0;
    let gameRunning = false;
    let score = 0;

    const player = {
      x: 100,
      y: groundY,
      w: 40,
      h: 40,
      vy: 0
    };

    function initAudio(stream) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      const bufferLength = analyser.fftSize;
      dataArray = new Uint8Array(bufferLength);

      source.connect(analyser);
      micReady = true;
    }

    function getVolume() {
      if (!micReady) return 0;

      analyser.getByteTimeDomainData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] - 128; // ë¬´ìŒ ê¸°ì¤€
        sum += Math.abs(v);
      }
      const avg = sum / dataArray.length; // í‰ê·  ì§„í­ (0~ëŒ€ëµ 50 ê·¼ì²˜)
      let volume = avg / 40; // 0~1 ì •ë„ë¡œ ì •ê·œí™”
      if (volume > 1) volume = 1;
      return volume;
    }

    function resetGame() {
      player.x = 100;
      player.y = groundY;
      player.vy = 0;
      obstacles = [];
      spawnTimer = 0;
      score = 0;
      gameRunning = true;
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function spawnObstacle() {
      const height = 60 + Math.random() * 60;
      const width = 30 + Math.random() * 20;
      obstacles.push({
        x: canvas.width,
        y: groundY + (player.h - height),
        w: width,
        h: height,
        passed: false
      });
    }

    function isColliding(a, b) {
      return !(
        a.x + a.w < b.x ||
        a.x > b.x + b.w ||
        a.y + a.h < b.y ||
        a.y > b.y + b.h
      );
    }

    function update(delta) {
      const volume = getVolume();

      // ì í”„ (ë°”ë‹¥ì— ìˆê³ , ì¼ì • ì†Œë¦¬ ì´ìƒì¼ ë•Œ)
      const onGround = (player.y >= groundY);
      if (onGround && volume > 0.25) {
        const baseJump = 10;
        const extraJump = volume * 18;
        player.vy = -(baseJump + extraJump);
      }

      // ì¤‘ë ¥ ì ìš©
      player.vy += gravity;
      player.y += player.vy;

      // ë°”ë‹¥ ì¶©ëŒ ì²˜ë¦¬
      if (player.y > groundY) {
        player.y = groundY;
        player.vy = 0;
      }

      // ì¥ì• ë¬¼ ìƒì„± íƒ€ì´ë¨¸
      spawnTimer += delta;
      if (spawnTimer > spawnInterval) {
        spawnObstacle();
        spawnTimer = 0;
        // ë‚œì´ë„ ì ì§„ ì¦ê°€
        if (spawnInterval > 800) {
          spawnInterval -= 30;
        }
      }

      // ì¥ì• ë¬¼ ì´ë™
      const speed = 4.5;
      for (let obs of obstacles) {
        obs.x -= speed;

        // ì ìˆ˜: í”Œë ˆì´ì–´ ë’¤ë¡œ ì§€ë‚˜ê°€ë©´ +1
        if (!obs.passed && obs.x + obs.w < player.x) {
          obs.passed = true;
          score++;
        }

        // ì¶©ëŒ ì²´í¬
        if (isColliding(player, obs)) {
          gameRunning = false;
        }
      }

      // í™”ë©´ ë°– ì¥ì• ë¬¼ ì œê±°
      obstacles = obstacles.filter(o => o.x + o.w > 0);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ë°”ë‹¥
      ctx.fillStyle = "#555";
      ctx.fillRect(0, groundY + player.h, canvas.width, canvas.height - groundY - player.h);

      // í”Œë ˆì´ì–´
      ctx.fillStyle = "#4caf50";
      ctx.fillRect(player.x, player.y, player.w, player.h);

      // ì¥ì• ë¬¼
      ctx.fillStyle = "#f44336";
      for (let obs of obstacles) {
        ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
      }

      // ì ìˆ˜
      ctx.fillStyle = "#fff";
      ctx.font = "20px sans-serif";
      ctx.fillText("Score: " + score, 10, 30);

      // í˜„ì¬ ë³¼ë¥¨ ë°” í‘œì‹œ
      const volume = getVolume();
      const barWidth = 200;
      const barHeight = 10;
      ctx.fillStyle = "#888";
      ctx.fillRect(10, 50, barWidth, barHeight);
      ctx.fillStyle = "#00e5ff";
      ctx.fillRect(10, 50, barWidth * volume, barHeight);
      ctx.fillStyle = "#fff";
      ctx.font = "12px sans-serif";
      ctx.fillText("Volume", 10, 45);

      if (!gameRunning) {
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff";
        ctx.font = "32px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("Game Over!", canvas.width / 2, canvas.height / 2 - 20);
        ctx.font = "20px sans-serif";
        ctx.fillText("Score: " + score, canvas.width / 2, canvas.height / 2 + 10);
        ctx.fillText("ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.", canvas.width / 2, canvas.height / 2 + 40);
        ctx.textAlign = "left";
      }
    }

    function gameLoop(timestamp) {
      if (!gameRunning) {
        draw();
        return;
      }
      const delta = timestamp - lastTime;
      lastTime = timestamp;

      update(delta);
      draw();

      requestAnimationFrame(gameLoop);
    }

    startBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        initAudio(stream);
        resetGame();
      } catch (err) {
        alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ê²Œì„ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        console.error(err);
      }
    });
  </script>
</body>
</html>
